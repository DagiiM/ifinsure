<header class="header">
    <div class="header-left">
        <button class="btn btn-secondary btn-sm" id="sidebar-toggle" style="display: none;">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        <span class="text-sm text-muted">
            {% now "l, F j, Y" %}
        </span>
    </div>
    
    <div class="header-center">
        <!-- Global Search -->
        <button class="header-search-btn" id="globalSearchTrigger" onclick="openSearchModal()">
            <svg class="header-search-icon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <span class="header-search-text">Search...</span>
            <div class="header-search-shortcut">
                <kbd>⌘</kbd><kbd>K</kbd>
            </div>
        </button>
    </div>
    
    <div class="header-right">
        <!-- Notifications -->
        <div class="dropdown header-notifications-dropdown">
            <button class="header-icon-btn dropdown-trigger" title="Notifications">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                {% if has_notifications %}
                <span class="header-notification-badge">{{ unread_notifications_count }}</span>
                {% endif %}
            </button>
            <div class="dropdown-menu dropdown-menu-right notification-dropdown-menu">
                <div class="dropdown-header-fancy">
                    <h4>Notifications</h4>
                    {% if has_notifications %}
                    <a href="{% url 'notifications:mark_all_read' %}" class="mark-all-read" onclick="return confirmMarkAllRead(event)">Mark all read</a>
                    {% endif %}
                </div>
                <div class="notification-dropdown-list" id="notificationDropdownList">
                    {% if unread_notifications_count > 0 %}
                    <div class="dropdown-loading">Loading...</div>
                    {% else %}
                    <div class="dropdown-empty">
                        <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <p>No new notifications</p>
                    </div>
                    {% endif %}
                </div>
                <div class="dropdown-footer-fancy">
                    <a href="{% url 'notifications:list' %}">View all notifications</a>
                </div>
            </div>
        </div>
        
        <!-- User Menu -->
        <div class="dropdown header-user-dropdown">
            <div class="header-user dropdown-trigger">
                <div class="avatar">{{ user.initials }}</div>
                <div class="header-user-info">
                    <div class="header-user-name">{{ user.get_full_name }}</div>
                    <div class="header-user-role">{{ user.get_user_type_display }}</div>
                </div>
                <svg class="header-user-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="dropdown-menu dropdown-menu-right">
                <div class="dropdown-header">
                    <div class="font-semibold">{{ user.get_full_name }}</div>
                    <div class="text-xs text-muted">{{ user.email }}</div>
                </div>
                <div class="dropdown-divider"></div>
                <a href="{% url 'accounts:profile' %}" class="dropdown-item">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Profile
                </a>
                <a href="{% url 'accounts:profile_edit' %}" class="dropdown-item">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Settings
                </a>
                <a href="{% url 'notifications:preferences' %}" class="dropdown-item">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    Notification Settings
                </a>
                <div class="dropdown-divider"></div>
                <a href="{% url 'accounts:logout' %}" class="dropdown-item text-danger">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </div>
</header>

<!-- Global Search Modal -->
<div class="search-modal" id="searchModal">
    <div class="modal-backdrop" onclick="closeSearchModal()"></div>
    <div class="search-modal-content">
        <div class="search-modal-header">
            <div class="search-modal-input-wrapper">
                <svg class="search-modal-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input 
                    type="search" 
                    id="globalSearchInput"
                    placeholder="Search everything..." 
                    autocomplete="off"
                >
                <kbd class="search-modal-shortcut">ESC</kbd>
            </div>
        </div>
        <div class="search-modal-body" id="searchModalResults">
            <div class="search-modal-initial">
                <div class="search-modal-recent" id="recentSearches">
                    <h5>Recent Searches</h5>
                    <div class="recent-items"><!-- Loaded dynamically --></div>
                </div>
                <div class="search-modal-quick">
                    <h5>Quick Links</h5>
                    <div class="quick-links">
                        <a href="{% url 'policies:list' %}" class="quick-link-item">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            My Policies
                        </a>
                        <a href="{% url 'claims:list' %}" class="quick-link-item">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                            Claims
                        </a>
                        <a href="{% url 'billing:invoices' %}" class="quick-link-item">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            Billing
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-modal-footer">
            <div class="search-modal-hints">
                <span><kbd>↑</kbd><kbd>↓</kbd> Navigate</span>
                <span><kbd>↵</kbd> Select</span>
                <span><kbd>ESC</kbd> Close</span>
            </div>
        </div>
    </div>
</div>

<script>
// Global Search Modal
function openSearchModal() {
    document.getElementById('searchModal').classList.add('active');
    document.getElementById('globalSearchInput').focus();
    loadRecentSearches();
}

function closeSearchModal() {
    document.getElementById('searchModal').classList.remove('active');
    document.getElementById('globalSearchInput').value = '';
    document.getElementById('searchModalResults').innerHTML = document.querySelector('.search-modal-initial').cloneNode(true).innerHTML;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearchModal();
    }
    if (e.key === 'Escape' && document.getElementById('searchModal').classList.contains('active')) {
        closeSearchModal();
    }
});

// Search input
let searchTimeout;
document.getElementById('globalSearchInput')?.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value;
    
    if (query.length < 2) {
        document.getElementById('searchModalResults').innerHTML = document.querySelector('.search-modal-initial')?.innerHTML || '';
        return;
    }
    
    searchTimeout = setTimeout(() => performGlobalSearch(query), 200);
});

function performGlobalSearch(query) {
    const resultsContainer = document.getElementById('searchModalResults');
    resultsContainer.innerHTML = '<div class="search-loading"><div class="spinner"></div>Searching...</div>';
    
    fetch(`/search/api/?q=${encodeURIComponent(query)}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.data.all && data.data.all.length > 0) {
            renderSearchResults(data.data);
        } else {
            resultsContainer.innerHTML = `
                <div class="search-no-results">
                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <p>No results for "${query}"</p>
                </div>
            `;
        }
    })
    .catch(() => {
        resultsContainer.innerHTML = '<div class="search-error">Search failed. Please try again.</div>';
    });
}

function renderSearchResults(data) {
    const container = document.getElementById('searchModalResults');
    let html = `<div class="search-results-header">${data.total} result${data.total !== 1 ? 's' : ''}</div>`;
    
    for (const [category, items] of Object.entries(data.categories)) {
        html += `<div class="search-category"><h5>${category}</h5>`;
        items.forEach(item => {
            html += `
                <a href="${item.url || '#'}" class="search-result-item">
                    <div class="result-icon">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="result-text">
                        <span class="result-title">${item.title}</span>
                        ${item.subtitle ? `<span class="result-subtitle">${item.subtitle}</span>` : ''}
                    </div>
                </a>
            `;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function loadRecentSearches() {
    fetch('/search/api/?recent=true', { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.recent && data.data.recent.length > 0) {
                const container = document.querySelector('#recentSearches .recent-items');
                if (container) {
                    container.innerHTML = data.data.recent.map(item => 
                        `<button class="recent-search-item" onclick="document.getElementById('globalSearchInput').value='${item.query}';performGlobalSearch('${item.query}');">${item.query}</button>`
                    ).join('');
                }
            }
        }).catch(() => {});
}

// Notification dropdown
function confirmMarkAllRead(e) {
    if (!confirm('Mark all notifications as read?')) {
        e.preventDefault();
        return false;
    }
    return true;
}

// Load notifications when dropdown opens
document.querySelector('.header-notifications-dropdown .dropdown-trigger')?.addEventListener('click', function() {
    const list = document.getElementById('notificationDropdownList');
    if (list && list.querySelector('.dropdown-loading')) {
        fetch('/notifications/api/', { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data.notifications && data.data.notifications.length > 0) {
                    list.innerHTML = data.data.notifications.slice(0, 5).map(n => `
                        <a href="/notifications/${n.id}/" class="notification-dropdown-item ${n.is_read ? '' : 'unread'}">
                            <div class="notification-icon ${n.type}">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                            </div>
                            <div class="notification-text">
                                <span class="notification-title">${n.title}</span>
                                <span class="notification-time">${n.time_ago}</span>
                            </div>
                        </a>
                    `).join('');
                } else {
                    list.innerHTML = `
                        <div class="dropdown-empty">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <p>No new notifications</p>
                        </div>
                    `;
                }
            }).catch(() => {});
    }
});
</script>
