{% extends 'base.html' %}
{% load humanize %}

{% block title %}Customers - ifinsure{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Customers</h1>
        <p class="page-subtitle">{{ total_customers }} total customers</p>
    </div>
    <a href="{% url 'crm:customer_create' %}" class="btn btn-primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
        </svg>
        Add Customer
    </a>
</div>

<!-- Filters -->
<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <select name="type" onchange="this.form.submit()">
                <option value="">All Types</option>
                <option value="individual" {% if selected_type == 'individual' %}selected{% endif %}>Individual</option>
                <option value="corporate" {% if selected_type == 'corporate' %}selected{% endif %}>Corporate</option>
            </select>
        </div>
        <div class="filter-group">
            <select name="stage" onchange="this.form.submit()">
                <option value="">All Stages</option>
                {% for value, label in stages %}
                <option value="{{ value }}" {% if selected_stage == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group search">
            <input type="text" name="q" value="{{ search_query }}" placeholder="Search customers...">
            <button type="submit">Search</button>
        </div>
    </form>
</div>

<!-- Customer Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Customer</th>
                <th>Type</th>
                <th>Contact</th>
                <th>Stage</th>
                <th>Agent</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in customers %}
            <tr onclick="window.location='{% url 'crm:customer_detail' pk=customer.pk %}'" class="clickable">
                <td>
                    <div class="customer-cell">
                        <div class="customer-avatar {{ customer.customer_type }}">
                            {% if customer.customer_type == 'corporate' %}
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"></path>
                            </svg>
                            {% else %}
                            {{ customer.first_name|slice:":1"|upper }}{{ customer.last_name|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div class="customer-info">
                            <span class="customer-name">{{ customer }}</span>
                            <span class="customer-number">{{ customer.customer_number }}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="type-badge {{ customer.customer_type }}">{{ customer.get_customer_type_display }}</span>
                </td>
                <td>
                    <div class="contact-info">
                        <span>{{ customer.phone|default:"-" }}</span>
                        <span class="email">{{ customer.email|default:"-" }}</span>
                    </div>
                </td>
                <td>
                    <span class="stage-badge stage-{{ customer.lifecycle_stage }}">{{ customer.get_lifecycle_stage_display }}</span>
                </td>
                <td>
                    {{ customer.assigned_agent.get_full_name|default:"-" }}
                </td>
                <td>
                    {{ customer.created_at|date:"M d, Y" }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="empty-cell">No customers found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_stage %}&stage={{ selected_stage }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">← Previous</a>
    {% endif %}
    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_stage %}&stage={{ selected_stage }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">Next →</a>
    {% endif %}
</div>
{% endif %}

<style>
.filter-bar {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.filter-form {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 150px;
}

.filter-group.search {
    flex: 2;
    display: flex;
    gap: 0.5rem;
}

.filter-form select, .filter-form input {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1px solid var(--color-gray-200);
    border-radius: 8px;
    font-size: 0.875rem;
}

.filter-form button {
    padding: 0.625rem 1.25rem;
    background: var(--color-primary-600);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}

.table-container {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    text-align: left;
    padding: 1rem 1.25rem;
    background: var(--color-gray-50);
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--color-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table td {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--color-gray-100);
    font-size: 0.875rem;
}

.data-table tr.clickable {
    cursor: pointer;
    transition: background 0.15s;
}

.data-table tr.clickable:hover {
    background: var(--color-gray-50);
}

.customer-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.customer-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
}

.customer-avatar.corporate {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.customer-info {
    display: flex;
    flex-direction: column;
}

.customer-name {
    font-weight: 600;
    color: var(--color-gray-900);
}

.customer-number {
    font-size: 0.75rem;
    color: var(--color-gray-500);
    font-family: monospace;
}

.type-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.type-badge.individual {
    background: #dbeafe;
    color: #1e40af;
}

.type-badge.corporate {
    background: #f3e8ff;
    color: #7c3aed;
}

.contact-info {
    display: flex;
    flex-direction: column;
    font-size: 0.8rem;
}

.contact-info .email {
    color: var(--color-gray-500);
}

.stage-badge {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    text-transform: uppercase;
}

.stage-lead { background: #e0e7ff; color: #4338ca; }
.stage-prospect { background: #fef3c7; color: #92400e; }
.stage-customer { background: #dcfce7; color: #166534; }
.stage-repeat { background: #dbeafe; color: #1e40af; }
.stage-vip { background: #fef3c7; color: #d97706; }
.stage-churned { background: #fee2e2; color: #dc2626; }

.empty-cell {
    text-align: center;
    color: var(--color-gray-400);
    padding: 3rem !important;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
}

.pagination a {
    padding: 0.5rem 1rem;
    background: white;
    border-radius: 8px;
    text-decoration: none;
    color: var(--color-primary-600);
    font-weight: 500;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.pagination span {
    color: var(--color-gray-500);
}
</style>
{% endblock %}
