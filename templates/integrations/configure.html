{% extends 'base.html' %}

{% block title %}Configure {{ provider.name }} - ifinsure{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <nav class="breadcrumb">
            <a href="{% url 'integrations:dashboard' %}">Integrations</a>
            <span>›</span>
            <a href="{% url 'integrations:category' provider.category.slug %}">{{ provider.category.get_name_display }}</a>
            <span>›</span>
            <span>Configure</span>
        </nav>
        <h1 class="page-title">Configure {{ provider.name }}</h1>
        <p class="page-subtitle">{{ provider.description|default:"Set up your integration" }}</p>
    </div>
</div>

<div class="configure-layout">
    <!-- Configuration Form -->
    <div class="configure-form-card">
        <div class="card-section-header">
            <h4>Configuration Settings</h4>
        </div>
        <form method="post" class="configure-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label>Configuration Name *</label>
                {{ form.name }}
                <span class="form-hint">A friendly name to identify this configuration (e.g., "Production M-Pesa")</span>
            </div>
            
            <div class="form-group">
                <label>Environment *</label>
                {{ form.environment }}
                <span class="form-hint">Use Sandbox for testing, Production for live transactions</span>
            </div>
            
            <div class="form-divider"></div>
            
            <h5 class="form-section-title">API Credentials</h5>
            
            {% for field_name, field_config in provider.config_schema.items %}
            <div class="form-group">
                <label>
                    {{ field_config.label }}
                    {% if field_config.required %}*{% endif %}
                </label>
                <input type="{{ field_config.type|default:'text' }}" 
                       name="credentials_{{ field_name }}" 
                       class="form-input"
                       {% if field_config.required %}required{% endif %}
                       placeholder="{{ field_config.placeholder|default:'' }}">
                {% if field_config.help_text %}
                <span class="form-hint">{{ field_config.help_text }}</span>
                {% endif %}
            </div>
            {% endfor %}
            
            {% if provider.supports_webhooks %}
            <div class="form-divider"></div>
            
            <h5 class="form-section-title">Webhook Configuration</h5>
            
            <div class="form-group">
                <label>Webhook URL</label>
                <div class="input-copy-group">
                    <input type="text" class="form-input readonly" readonly 
                           value="{{ webhook_url }}" id="webhookUrl">
                    <button type="button" onclick="copyWebhookUrl()" class="copy-btn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Copy
                    </button>
                </div>
                <span class="form-hint">Configure this URL in your {{ provider.name }} dashboard</span>
            </div>
            {% endif %}
            
            <div class="form-divider"></div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_enabled">
                    <span class="checkbox-custom"></span>
                    <span>Enable this integration immediately</span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_primary">
                    <span class="checkbox-custom"></span>
                    <span>Set as primary {{ provider.category.get_name_display|lower }} provider</span>
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="form-btn primary">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Save Configuration
                </button>
                <button type="submit" name="test_connection" class="form-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Save & Test
                </button>
                <a href="{% url 'integrations:category' provider.category.slug %}" class="form-btn cancel">Cancel</a>
            </div>
        </form>
    </div>
    
    <!-- Provider Info Sidebar -->
    <div class="configure-sidebar">
        <div class="provider-info-card">
            <div class="provider-logo-wrapper">
                {% if provider.logo %}
                <img src="{{ provider.logo.url }}" alt="{{ provider.name }}">
                {% else %}
                <span class="provider-logo-placeholder">{{ provider.name|slice:":2"|upper }}</span>
                {% endif %}
            </div>
            <h4>{{ provider.name }}</h4>
            <p class="provider-category">{{ provider.category.get_name_display }}</p>
            
            <div class="provider-feature-badges">
                {% if provider.supports_webhooks %}
                <span class="feature-badge green">Webhooks</span>
                {% endif %}
                {% if provider.supports_sandbox %}
                <span class="feature-badge blue">Sandbox</span>
                {% endif %}
            </div>
            
            {% if provider.website_url %}
            <a href="{{ provider.website_url }}" target="_blank" class="provider-website-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
                Visit Website
            </a>
            {% endif %}
        </div>
        
        {% if provider.documentation_url %}
        <div class="docs-card">
            <h5>Documentation</h5>
            <p>Need help setting up? Check the official documentation:</p>
            <a href="{{ provider.documentation_url }}" target="_blank" class="docs-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                View Documentation
            </a>
        </div>
        {% endif %}
        
        <div class="setup-guide-card">
            <h5>Setup Guide</h5>
            <div class="setup-steps">
                <div class="setup-step">
                    <span class="step-num">1</span>
                    <div class="step-info">
                        <h6>Get API Keys</h6>
                        <p>Login to your {{ provider.name }} dashboard and get your API credentials</p>
                    </div>
                </div>
                <div class="setup-step">
                    <span class="step-num">2</span>
                    <div class="step-info">
                        <h6>Enter Credentials</h6>
                        <p>Fill in your API keys and secrets in the form</p>
                    </div>
                </div>
                <div class="setup-step">
                    <span class="step-num">3</span>
                    <div class="step-info">
                        <h6>Test Connection</h6>
                        <p>Verify your configuration works correctly</p>
                    </div>
                </div>
                <div class="setup-step">
                    <span class="step-num">4</span>
                    <div class="step-info">
                        <h6>Go Live</h6>
                        <p>Enable the integration when ready</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.breadcrumb a {
    color: var(--color-gray-500);
    text-decoration: none;
}

.breadcrumb a:hover {
    color: var(--color-primary-600);
}

.breadcrumb span {
    color: var(--color-gray-400);
}

.configure-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 1.5rem;
    align-items: start;
}

@media (max-width: 900px) {
    .configure-layout { grid-template-columns: 1fr; }
}

/* Form Card */
.configure-form-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.card-section-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-gray-100);
}

.card-section-header h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 700;
}

.configure-form {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--color-gray-700);
    margin-bottom: 0.5rem;
}

.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="email"],
.form-group select,
.configure-form .form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--color-gray-200);
    border-radius: 10px;
    font-size: 0.9rem;
    transition: all 0.15s;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
}

.form-input.readonly {
    background: var(--color-gray-50);
}

.form-hint {
    display: block;
    font-size: 0.75rem;
    color: var(--color-gray-500);
    margin-top: 0.375rem;
}

.form-divider {
    height: 1px;
    background: var(--color-gray-100);
    margin: 1.5rem 0;
}

.form-section-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--color-gray-900);
    margin: 0 0 1rem;
}

.input-copy-group {
    display: flex;
    gap: 0.5rem;
}

.input-copy-group input {
    flex: 1;
}

.copy-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--color-gray-200);
    border-radius: 10px;
    background: white;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-gray-600);
    cursor: pointer;
    transition: all 0.15s;
}

.copy-btn:hover {
    background: var(--color-gray-50);
}

/* Checkbox */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-size: 0.9rem !important;
    font-weight: 400 !important;
}

.checkbox-label input {
    display: none;
}

.checkbox-custom {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-gray-300);
    border-radius: 6px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.checkbox-label input:checked + .checkbox-custom {
    background: var(--color-primary-600);
    border-color: var(--color-primary-600);
}

.checkbox-label input:checked + .checkbox-custom::after {
    content: '';
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

/* Form Actions */
.form-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.form-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border: 1px solid var(--color-gray-200);
    border-radius: 10px;
    background: white;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-gray-700);
    cursor: pointer;
    text-decoration: none;
    transition: all 0.15s;
}

.form-btn:hover {
    background: var(--color-gray-50);
}

.form-btn.primary {
    background: var(--color-primary-600);
    border-color: var(--color-primary-600);
    color: white;
}

.form-btn.primary:hover {
    background: var(--color-primary-700);
}

.form-btn.cancel {
    color: var(--color-gray-500);
}

/* Sidebar */
.configure-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.provider-info-card, .docs-card, .setup-guide-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.provider-logo-wrapper {
    width: 80px;
    height: 80px;
    border-radius: 20px;
    overflow: hidden;
    margin: 0 auto 1rem;
}

.provider-logo-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.provider-logo-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-primary-100), var(--color-primary-200));
    color: var(--color-primary-600);
    font-size: 1.5rem;
    font-weight: 700;
}

.provider-info-card h4 {
    text-align: center;
    margin: 0 0 0.25rem;
    font-size: 1.125rem;
}

.provider-category {
    text-align: center;
    color: var(--color-gray-500);
    font-size: 0.875rem;
    margin: 0 0 1rem;
}

.provider-feature-badges {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 1rem;
}

.feature-badge {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.feature-badge.green {
    background: #dcfce7;
    color: #166534;
}

.feature-badge.blue {
    background: #dbeafe;
    color: #1e40af;
}

.provider-website-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1px solid var(--color-gray-200);
    border-radius: 10px;
    background: white;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-gray-600);
    text-decoration: none;
    transition: all 0.15s;
}

.provider-website-btn:hover {
    background: var(--color-gray-50);
}

.docs-card h5, .setup-guide-card h5 {
    margin: 0 0 0.75rem;
    font-size: 0.9rem;
    font-weight: 700;
}

.docs-card p {
    font-size: 0.8rem;
    color: var(--color-gray-500);
    margin: 0 0 0.75rem;
}

.docs-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.625rem 1rem;
    background: var(--color-primary-50);
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--color-primary-600);
    text-decoration: none;
    transition: all 0.15s;
}

.docs-btn:hover {
    background: var(--color-primary-100);
}

/* Setup Steps */
.setup-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.setup-step {
    display: flex;
    gap: 0.75rem;
}

.step-num {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--color-primary-100);
    color: var(--color-primary-600);
    font-weight: 700;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.step-info h6 {
    margin: 0 0 0.125rem;
    font-size: 0.85rem;
    font-weight: 600;
}

.step-info p {
    margin: 0;
    font-size: 0.75rem;
    color: var(--color-gray-500);
    line-height: 1.4;
}
</style>

<script>
function copyWebhookUrl() {
    const input = document.getElementById('webhookUrl');
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Copied!
        `;
        setTimeout(() => {
            btn.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Copy
            `;
        }, 2000);
    });
}
</script>
{% endblock %}
